name: Deploy ASP.NET Core MVC to Azure VM

on:
  push:
    branches: [ "master" ]

env:
  DOTNET_VERSION: '10.0.x'
  PROJECT_PATH: 'SIM600.Simulation/SIM600.Simulation.csproj'
  APP_NAME: 'mvcapp'
  DEPLOY_PATH: '/home/azureuser/mvcapp'

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
    - uses: actions/checkout@v4

    - name: Verify .NET installation
      run: dotnet --version

    - name: Restore dependencies
      run: dotnet restore ${{ env.PROJECT_PATH }}

    - name: Build
      run: dotnet build ${{ env.PROJECT_PATH }} --configuration Release --no-restore

    - name: Publish
      run: dotnet publish ${{ env.PROJECT_PATH }} --configuration Release --no-build --output publish

    # üîπ BACKUP PRODUCTION FILES
    - name: Backup production config and database
      run: |
        # Backup production config
        if [ -f ${{ env.DEPLOY_PATH }}/appsettings.Production.json ]; then
          sudo cp ${{ env.DEPLOY_PATH }}/appsettings.Production.json /tmp/appsettings.Production.json.bak
          echo "‚úÖ Production config backed up"
        fi
        # Backup SQLite database
        if [ -f ${{ env.DEPLOY_PATH }}/app.db ]; then
          sudo cp ${{ env.DEPLOY_PATH }}/app.db /tmp/app.db.bak
          echo "‚úÖ Database backed up"
        fi

    # üîπ BACKUP CURRENT DEPLOYMENT
    - name: Backup current app
      run: |
        if [ -d ${{ env.DEPLOY_PATH }} ]; then
          sudo rm -rf ${{ env.DEPLOY_PATH }}_prev
          sudo mv ${{ env.DEPLOY_PATH }} ${{ env.DEPLOY_PATH }}_prev
        fi
        sudo mkdir -p ${{ env.DEPLOY_PATH }}

    # üîπ COPY NEW BUILD
    - name: Deploy files
      run: |
        sudo cp -r publish/* ${{ env.DEPLOY_PATH }}/
        sudo chown -R www-data:www-data ${{ env.DEPLOY_PATH }}

    # üîπ RESTORE PRODUCTION FILES
    - name: Restore production config and database
      run: |
        # Restore production config
        if [ -f /tmp/appsettings.Production.json.bak ]; then
          sudo cp /tmp/appsettings.Production.json.bak ${{ env.DEPLOY_PATH }}/appsettings.Production.json
          sudo chown www-data:www-data ${{ env.DEPLOY_PATH }}/appsettings.Production.json
          sudo rm /tmp/appsettings.Production.json.bak
          echo "‚úÖ Production config restored"
        fi
        # Restore SQLite database
        if [ -f /tmp/app.db.bak ]; then
          sudo cp /tmp/app.db.bak ${{ env.DEPLOY_PATH }}/app.db
          sudo chown www-data:www-data ${{ env.DEPLOY_PATH }}/app.db
          sudo rm /tmp/app.db.bak
          echo "‚úÖ Database restored"
        fi

    # üîπ RESTART APP
    - name: Restart service
      run: sudo systemctl restart ${{ env.APP_NAME }}

    # üîπ HEALTH CHECK
    - name: Verify deployment
      run: |
        sleep 10
        if systemctl is-active --quiet ${{ env.APP_NAME }}; then
          echo "‚úÖ Service is running"
        else
          echo "‚ùå Service failed to start"
          sudo systemctl status ${{ env.APP_NAME }}
          exit 1
        fi

    # üîπ ROLLBACK ON FAILURE
    - name: Rollback on failure
      if: failure()
      run: |
        if [ -d ${{ env.DEPLOY_PATH }}_prev ]; then
          echo "üîÑ Rolling back to previous version..."
          sudo rm -rf ${{ env.DEPLOY_PATH }}
          sudo mv ${{ env.DEPLOY_PATH }}_prev ${{ env.DEPLOY_PATH }}
          sudo systemctl restart ${{ env.APP_NAME }}
          echo "‚úÖ Rollback complete"
        else
          echo "‚ö†Ô∏è No previous version to rollback to"
        fi
